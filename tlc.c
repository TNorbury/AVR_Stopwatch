//------------------------------------------------------------------------------
//             __             __   ___  __
//     | |\ | /  ` |    |  | |  \ |__  /__`
//     | | \| \__, |___ \__/ |__/ |___ .__/
//
//------------------------------------------------------------------------------

#include "tlc.h"
#include <avr/io.h>
#include <avr/interrupt.h>

//------------------------------------------------------------------------------
//      __   ___  ___         ___  __
//     |  \ |__  |__  | |\ | |__  /__`
//     |__/ |___ |    | | \| |___ .__/
//
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
//     ___      __   ___  __   ___  ___  __
//      |  \ / |__) |__  |  \ |__  |__  /__`
//      |   |  |    |___ |__/ |___ |    .__/
//
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
//                __          __        ___  __
//     \  /  /\  |__) |  /\  |__) |    |__  /__`
//      \/  /~~\ |  \ | /~~\ |__) |___ |___ .__/
//
//------------------------------------------------------------------------------

static volatile uint8_t spi_busy = 1;
static volatile uint8_t first_byte = 1;
static volatile uint8_t byte_2;

//------------------------------------------------------------------------------
//      __   __   __  ___  __  ___      __   ___  __
//     |__) |__) /  \  |  /  \  |  \ / |__) |__  /__`
//     |    |  \ \__/  |  \__/  |   |  |    |___ .__/
//
//------------------------------------------------------------------------------

static void spi_init();
static void pulse_latch();
static uint8_t spi (uint8_t data);

//------------------------------------------------------------------------------
//      __        __          __
//     |__) |  | |__) |    | /  `
//     |    \__/ |__) |___ | \__,
//
//------------------------------------------------------------------------------

//==============================================================================
void tlc_init()
{
  spi_init();

  //Setup BLANK
  DDRD |= (1<<7);

  //Set up latch
  DDRC |= (1<<5);

}

//==============================================================================
uint8_t tlc_write(uint16_t value)
{
  uint8_t return_val;
  uint8_t value_low;
  uint8_t value_high;
  
  
  if (spi_busy == 0)
  {
    
    //The value won't be processed, so return 1
    return_val = 1;
  }
  else
  {
    
    //Break the 16bit value into two 8bit values
    value_low = value & 0xFF;
    value_high = value >> 8;
    
    //Save the high byte and send the low byte
    byte_2 = value_high;
    spi(value_low);
    first_byte = 0;
    spi_busy = 0;
    
    //The value will be processed successfully, so return 0
    return_val = 0;
  }
  
  return return_val;
}


//==============================================================================
void tlc_turn_on_anode(uint8_t anode)
{
  DDRC |= (1<<anode);
}


//==============================================================================
void tlc_turn_off_anodes()
{
  
  //Turn off all the lights
  DDRC &= ~(0x1e);
}

//------------------------------------------------------------------------------
//      __   __              ___  ___
//     |__) |__) | \  /  /\   |  |__
//     |    |  \ |  \/  /~~\  |  |___
//
//------------------------------------------------------------------------------
static void spi_init()
{

  //Set up MOSI - PB3, SCK - PB5 as outputs
  PORTB &= ~((1<<3)|(1<<5));
  DDRB |= ((1<<3|(1<<5)));

  //Set up MISO - PB4 as input
  DDRB &= ~(1<<4);

  //Set up SS as an output (PB2), even though we aren't using it
  DDRB |= (1<<2);

  //Set up the SPI
  //SPI Type: Master
  //SPI Clock Rate: 250 kHz
  //SPI Clock Phase: Cycle Start
  //SPI CLock Polarity: Low
  //SPI Data Order: MSB First
  SPCR = 0xD2;
  SPSR = 0x00;
}


static void pulse_latch()
{
  PORTC |= (1<<5);
  PORTC &= ~(1<<5);
}

static uint8_t spi (uint8_t data)
{
  //Write to the SPI
  SPDR = data;

  return (SPDR);
}

//------------------------------------------------------------------------------
//      __                  __        __        __
//     /  `  /\  |    |    |__)  /\  /  ` |__/ /__`
//     \__, /~~\ |___ |___ |__) /~~\ \__, |  \ .__/
//
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
//        __   __  , __
//     | /__` |__)  /__`
//     | .__/ |  \  .__/
//
//------------------------------------------------------------------------------
ISR(SPI_STC_vect)
{
  if (first_byte == 0)
  {
    spi(byte_2);
    first_byte = 1;
  }
  else
  {
    spi_busy = 1;
    pulse_latch();
  }
}